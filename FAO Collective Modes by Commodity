setwd('D:/OneDrive - CGIAR/Documents')
library(stats)
library(plyr)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(tidyr)
library(TSA)

subregion_vec <- c("Eastern Africa",
                   "Middle Africa",
                   "Northern Africa",
                   "Southern Africa",
                   "Western Africa",
                   "Northern America",
                   "Central America",
                   "Caribbean",
                   "South America",
                   "Eastern Asia",
                   "Central Asia",
                   "Southern Asia",
                   "South-Eastern Asia",
                   "Western Asia",
                   "Eastern Europe",
                   "Northern Europe",
                   "Southern Europe",
                   "Western Europe",
                   "Australia & New Zealand",
                   "World")

#unique(ExportData_raw$Item)[grep("Potatoes", unique(ExportData_raw$Item))]

cerealPrimary_vec <- c("Maize", "Wheat", "Barley", "Rice", "Millet", "Rye", "Sorghum")
cerealSecondary_vec <- c("Flour, maize", "Flour, wheat", "Cake, maize")

RnTPrimary_vec <- c("Sweet potatoes", "Cassava Equivalent", "Potatoes")
RnTSecondary_vec <- c("Starch, cassava", "Cassava dried", "Flour, potatoes")

fruits_vec <- c("Oranges+Tang+Clem", "Tomatoes", "Plantains and others", "Mangoes, mangosteens, guavas", "Bananas")

pulses_vec <- c("Flour, pulses", "Lentils", "Beans, dry")

OilPrimary_vec <- c("Soybeans", "Cottonseed", "Linseed", "Coconuts")
OilSecondary_vec <- c("Oil, soybean", "Oil, palm", "Oil, maize", "Oil, coconut (copra)", "Olive Oil,Total")

SugarcropsPrimary_vec <- c("Sugar beet", "Sugar Raw Centrifugal")
SugarcropsSecondary_vec <- c("Beet pulp")

teaCoffeeCacao <- c("Tea", "Cocoa, butter", "Cocoa, paste", "Cocoa, beans", "Coffee, roasted", "Coffee, green")

textileIndustrial <- c("Cotton lint", "Wool, greasy", "Wool, degreased", "Rubber, natural", "Cotton, carded, combed", "Silk raw")
#---
cereal_vec <- c(cerealPrimary_vec, cerealSecondary_vec)
RnT_vec <- c(RnTPrimary_vec, RnTSecondary_vec)
oil_vec <- c(OilPrimary_vec, OilSecondary_vec)
sugar_vec <- c(SugarcropsPrimary_vec, SugarcropsSecondary_vec)
#---
item_vec <- c(cereal_vec, RnT_vec, oil_vec, fruits_vec, pulses_vec, sugar_vec, teaCoffeeCacao, textileIndustrial)
#---
ExportData_raw <- read.csv("Trade_Crops_Livestock_E_All_Data.csv", stringsAsFactors = F)
ExportData_raw <- subset(ExportData_raw, Item.Code != 2928)
ExportData_raw$Area.Code <- NULL
ExportData_raw$Element.Code <-NULL
ExportData_raw$Item <- as.character(ExportData_raw$Item)
ExportData_raw$Element <- as.character(ExportData_raw$Element)
ExportData_raw$Area <- as.character(ExportData_raw$Area)
u <- colnames(ExportData_raw)
ExportData_raw <- ExportData_raw[, -grep("F", u)]
colnames(ExportData_raw)[6:ncol(ExportData_raw)] <- as.character(c(1961:2013))
ExportData_raw <- gather(ExportData_raw,Year,Value,`1961`:`2013`)
rm(u)
colnames(ExportData_raw)
unique(ExportData_raw$Element)
ExportData_raw <- subset(ExportData_raw, Element %in% c("Export Quantity", "Export Value"))
ExportData_raw$Item.Code <- NULL
ExportData_raw$Unit <- NULL
#--
ExportData <- subset(ExportData_raw, Area %in% subregion_vec)
LAC <- c("Central America", "Caribbean", "South America")
Europe_E <- "Eastern Europe"
Europe_WNS <- c("Southern Europe", "Western Europe", "Northern Europe")
SSA <- c("Eastern Africa", "Southern Africa", "Western Africa", "Middle Africa")
ESE_Asia <- c("South-Eastern Asia", "Eastern Asia")
u <- ExportData$Area
ExportData$Area[which(u %in% LAC)] <- "LAC"
ExportData$Area[which(u %in% Europe_E)] <- "E. Europe"
ExportData$Area[which(u %in% Europe_WNS)] <- "W., N., & S. Europe"
ExportData$Area[which(u %in% SSA)] <- "Sub-Saharan Africa"
ExportData$Area[which(u %in% ESE_Asia)] <- "E. & S.E. Asia"
#--
ExportData <- subset(ExportData, Item %in% item_vec)
ExportData <- ExportData %>% group_by(Area, Year, Item, Element) %>% summarise(Value = sum(Value))
ExportData$Group <- NA
u <- ExportData$Item
ExportData$Group[which(u %in% cereal_vec)] <- "Cereals"
ExportData$Group[which(u %in% RnT_vec)] <- "RnT"
ExportData$Group[which(u %in% oil_vec)] <- "Oils"
ExportData$Group[which(u %in% sugar_vec)] <- "Sugars"
ExportData$Group[which(u %in% fruits_vec)] <- "Fruit"
ExportData$Group[which(u %in% pulses_vec)] <- "Pulses"
ExportData$Group[which(u %in% teaCoffeeCacao)] <- "Tea, coffee, cacao"
ExportData$Group[which(u %in% textileIndustrial)] <- "Industrial (textile, rubber)"
#--
u <- ExportData$Value
ExportData$Value[which(is.na(u) == T | is.nan(u) == T | is.infinite(u) == T)] <- 0
#which(is.na(ExportData$Item) == T)
ExportData <- ExportData %>% group_by(Area, Year, Group, Item, Element) %>% summarise(Value = sum(Value, na.rm = T))
#-----------------------------
#this_region <- "E. & S.E. Asia"
this_region <- "World"
#-----------------------------
df_price <- ExportData
#unique(df_price$Item)
df_price <- df_price %>% spread(Element, Value)
#df_price <- as.data.frame(df_price %>% spread(Element, Value))
# unique(df_price$Item)
# u <- df_price$Item
# df_price$Item[u == "Roots and tubers, nes"] <- "Starchy Roots"
# df_price$Item[u == "Sugar,Total (Raw Equiv.)"] <- "Sugar"
df_price$`Export Quantity` <- df_price$`Export Quantity` * 1000
df_price$`Export Value` <- df_price$`Export Value` * 1000
df_price$Price <- df_price$`Export Value` / df_price$`Export Quantity`
df_price <- df_price %>% group_by(Area, Item) %>% 
  mutate(isMiss = ifelse(is.na(Price) | is.nan(Price) | Price == 0, 1, 0))
df_price <- df_price %>% group_by(Area, Item) %>% 
  mutate(nMiss = sum(isMiss))
df_price <- as.data.frame(df_price)
#--
df_group <- subset(df_price, Area == this_region & Year == 2010)
items_rm <- unique(df_group$Item[which(df_group$nMiss > 5)])
df_group <- subset(df_group, !(Item %in% items_rm))
df_group <- df_group[, c("Group", "Item")]
col_order <- df_group$Item
#--
df_price <- subset(df_price, Area == this_region)
items_rm <- unique(df_price$Item[which(df_price$nMiss > 5)])
df_price <- subset(df_price, !(Item %in% items_rm))
unique(df_price$Item[which(df_price$isMiss == 1)])
#unique(df_price$Item)
df_price$Price[which(is.infinite(df_price$Price))] <- NaN
df_price <- df_price %>% group_by(Area, Group, Item) %>%
  mutate(Price = ifelse(is.nan(Price) | Price == 0, mean(Price, na.rm = T), Price))
df_price <- as.data.frame(df_price)

df_price$`Export Quantity` <- NULL
df_price$`Export Value` <- NULL
df_price$isMiss <- NULL
df_price$nMiss <- NULL
df_price$Group <- NULL
df_price$Area <- NULL
df_price <- as.data.frame(df_price)
df_mat <- df_price %>% spread(Item, Price)
colnames(df_mat)
row.names(df_mat) <- df_mat$Year
df_mat$Year <- NULL
colnames(df_mat)
df_mat <- df_mat[, col_order]
difflnMat <- diff(as.matrix(log(df_mat)))
ts_mat <- difflnMat
cormat <- cor(ts_mat)
image(cormat)
#--
eig_vectors <- -eigen(cormat)$vectors
lam_cor <- eigen(cormat)$values
lamcor_max <- max(lam_cor)
N_t <- nrow(ts_mat)
N_c <- ncol(ts_mat)
Q <- N_t / N_c
s_sq <- 1 - lamcor_max / N_c
#s_sq <- 1
lamrand_max <- s_sq * (1 + 1 / Q + 2 / sqrt(Q))
lamrand_min <- s_sq * (1 + 1 / Q - 2 / sqrt(Q))
lam <- seq(lamrand_min, lamrand_max, 0.2)
dens_rand <- Q / (2 * pi * s_sq) * sqrt((lamrand_max - lam) * (lam - lamrand_min)) / lam
#--
df_e <- data.frame(values = lam_cor)
gg <- ggplot() + geom_density(data = df_e, aes(x = values), color = "blue") + coord_cartesian(xlim = c(0, ceiling(lamcor_max)))
gg <- gg + geom_line(data = data.frame(x = lam, y = dens_rand), aes(x = x, y = y), linetype = "dotted")
gg
#--
ind_deviating_from_noise <- which(lam_cor > lamrand_max)
CollectiveModes <- as.matrix(eig_vectors[, ind_deviating_from_noise])
df_collectiveModes <- as.data.frame(CollectiveModes)
n_collectiveModes <- ncol(CollectiveModes)
print(paste("Number of collective modes: ", n_collectiveModes))
#Contributions of groups to each mode
n_all_ts <- length(col_order)
groups <- unique(df_group$Group)
n_groups <- length(groups)
N_in_group <- c()
Pvec_list <- list()
for(i in 1:n_groups){
  this_group <- groups[i]
  Pvec <- rep(0, n_all_ts)
  ind <- which(df_group$Group == this_group)
  ts_in_group <- df_group$Item[ind]
  n_in_group <- length(ts_in_group)
  Pvec[ind] <- 1 / n_in_group
  Pvec_list[[i]] <- Pvec
  N_in_group[i] <- n_in_group
}
Pmat <- as.matrix(do.call(cbind, Pvec_list))
nrow(Pmat)
nrow(df_collectiveModes)
Xkl <- t(Pmat) %*% CollectiveModes^2
#barplot(Xkl[, 9])
df_contrib <- as.data.frame(Xkl)
colnames(df_contrib) <- paste("lambda", c(1:n_collectiveModes))
df_contrib$Group <- groups
gathercols <- colnames(df_contrib)[1:n_collectiveModes]
df_contrib <- gather_(df_contrib, "Lambda", "Value", gathercols)
gg <- ggplot(df_contrib, aes(x = Group, y = Value)) + geom_bar(stat="identity")
gg <- gg + facet_wrap(~ Lambda, nrow = floor(n_collectiveModes / 2)) + theme(axis.text.x = element_text(angle = 60, hjust = 1))
gg
#Symmetric and Anti-Symmetric Combinations of contributions to modes
SymmComb <- (CollectiveModes[, 3] + CollectiveModes[, 4]) / sqrt(2)
AntiSymmComb <- (CollectiveModes[, 3] - CollectiveModes[, 4]) / sqrt(2)

Xkl <- t(Pmat) %*% cbind(SymmComb, AntiSymmComb)^2
#barplot(Xkl[, 9])
df_contrib <- as.data.frame(Xkl)
colnames(df_contrib) <- c("SymmComb12", "AntiSymmComb12")
df_contrib$Group <- groups
gathercols <- colnames(df_contrib)[1:2]
df_contrib <- gather_(df_contrib, "Lambda", "Value", gathercols)
gg <- ggplot(df_contrib, aes(x = Group, y = Value)) + geom_bar(stat="identity")
gg <- gg + facet_wrap(~ Lambda, nrow = 1) + theme(axis.text.x = element_text(angle = 60, hjust = 1))
gg

# Collective mode time series
#ts_Coll_mat <- difflnMat %*% CollectiveModes
#ts_avg <- difflnMat %*% rep(1, n_all_ts) * 1 / n_all_ts
#ts_Coll_mat <- as.matrix(df_mat) %*% cbind(CollectiveModes, cbind(SymmComb, AntiSymmComb))
ts_Coll_mat <- as.matrix(df_mat) %*% CollectiveModes
#ts_Coll_mat[, 2] <- -ts_Coll_mat[, 2]
ts_avg <- as.matrix(df_mat) %*% rep(1, n_all_ts) * 1 / n_all_ts
# class(ts_Coll_mat)
# class(ts_avg)
df_plot <- data.frame(Avg = ts_avg, ts_Coll_mat)
df_plot$Year = as.integer(row.names(df_plot))
gathercols <- colnames(df_plot[, c(1:(ncol(df_plot) - 1))])
df_plot <- df_plot %>% gather_("Type", "Value", gathercols)
zdf_plot <- df_plot %>% group_by(Type) %>% mutate(Value = scale(Value))

gg <- ggplot(zdf_plot, aes(x = Year, y = Value, group = Type, color = Type))
gg <- gg + geom_line()
gg


# Autocorrelation
ts_Coll_mat <- difflnMat %*% CollectiveModes
acf(ts_Coll_mat[, 3])
acf(difflnMat[, 1])
pacf(ts_Coll_mat[, 4])
pacf(difflnMat[, 30])










# p <- periodogram(ts_Coll_mat[, 2])
# period <- 1 / p$freq[1:4]
# period


# #===================
# # Aside:
# # Reverse engineering a correlation matrix
# nrow <- 10
# ncol <- 10
# Pmat1 <- matrix(rbinom(nrow*ncol, 1, .5), nrow, ncol)
# n_vec <- as.vector(Pmat1 %*% rep(1, nrow))
# Pmat1 <- diag(1 / n_vec, nrow, ncol) %*% Pmat1
# invPmat1 <- solve(Pmat1)
# n_eigenvecs <- 3
# xx <- matrix(exp(rnorm(nrow * n_eigenvecs)), nrow, n_eigenvecs) 
# Contribution_estimated <- sweep(xx, 2, colSums(xx), FUN="/")
# colSums(Contribution_estimated)
# #--
# df_contrib <- as.data.frame(Contribution_estimated)
# colnames(df_contrib) <- paste("lambda", c(1:n_eigenvecs))
# df_contrib$Group <- letters[1:ncol]
# gathercols <- colnames(df_contrib)[1:n_eigenvecs]
# df_contrib <- gather_(df_contrib, "Lambda", "Value", gathercols)
# gg <- ggplot(df_contrib, aes(x = Group, y = Value)) + geom_bar(stat="identity")
# gg <- gg + facet_wrap(~ Lambda, nrow = floor(n_eigenvecs / 2)) + theme(axis.text.x = element_text(angle = 60, hjust = 1))
# gg
# eigen_vectors_sq <- invPmat1 %*% Contribution_estimated
# #=====================



#---
food_general_vec <- c("Cereals - Excluding Beer", "Starchy Roots", "Pulses", "Oilcrops", "Grand Total")

food_cereal_vec <- c("Barley and products", "Rye and products", "Rice (Milled Equivalent)",
                     "Sorghum and products", "Wheat and products", "Maize and products", "Millet and products")
food_RnT_vec <- c("Cassava and products", "Potatoes and products", "Sweet potatoes")
food_pulses_vec <- c("Beans")
food_fruits_vec <- c("Oranges+Tang+Clem", "Plantains and others", "Mangoes, mangosteens, guavas", "Bananas")
food_oil_vec <- c("Coconut Oil", "Palmkernel Oil", "Palm Oil", "Soyabeans", "Soyabean Oil")
food_sugar_vec <- c("Sugar (Raw Equivalent)")
food_teaCoffeeCacao <- c("Tea (including mate)", "Cocoa Beans and products", "Coffee and products")
food_textileIndustrial <- c("Cotton lint", "Wool, greasy", "Wool, degreased", "Rubber, natural", "Cotton, carded, combed", "Silk raw")
#---
foodbal_item_vec <- c(cereal_vec, RnT_vec, oil_vec, fruits_vec, pulses_vec, sugar_vec, teaCoffeeCacao, textileIndustrial)


FoodBal_raw <- read.csv("FoodBalanceSheets_E_All_Data.csv", stringsAsFactors = F)
#unique(FoodBal_raw[which(FoodBal_raw$Item.Code == 2928),"Item"])
FoodBal_raw <- subset(FoodBal_raw, Item.Code != 2928) #Miscellaneous
FoodBal_raw <- subset(FoodBal_raw, !(Item.Code %in% c(2949, 2948))) #Eggs and Milk are repeated for some reason
FoodBal_raw$Area.Code <- NULL
#FoodBal_raw$Item.Code <- NULL
FoodBal_raw$Element.Code <-NULL
FoodBal_raw$Item <- as.character(FoodBal_raw$Item)
FoodBal_raw$Element <- as.character(FoodBal_raw$Element)
FoodBal_raw$Area <- as.character(FoodBal_raw$Area)
u <- colnames(FoodBal_raw)
FoodBal_raw <- FoodBal_raw[, -grep("F", u)]
colnames(FoodBal_raw)[6:ncol(FoodBal_raw)] <- as.character(c(1961:2013))
FoodBal_raw <- gather(FoodBal_raw,Year,Value,`1961`:`2013`)
colnames(FoodBal_raw)

FoodBal <- subset(FoodBal_raw, Area %in% subregion_vec)
# unique(FoodBal$Item)
# unique(FoodBal$Element)
LAC <- c("Central America", "Caribbean", "South America")
Europe_E <- "Eastern Europe"
Europe_WNS <- c("Southern Europe", "Western Europe", "Northern Europe")
SSA <- c("Eastern Africa", "Southern Africa", "Western Africa", "Middle Africa")
ESE_Asia <- c("South-Eastern Asia", "Eastern Asia")
u <- FoodBal$Area
FoodBal$Area[which(u %in% LAC)] <- "LAC"
FoodBal$Area[which(u %in% Europe_E)] <- "E. Europe"
FoodBal$Area[which(u %in% Europe_WNS)] <- "W., N., & S. Europe"
FoodBal$Area[which(u %in% SSA)] <- "Sub-Saharan Africa"
FoodBal$Area[which(u %in% ESE_Asia)] <- "E. & S.E. Asia"

FoodBal <- FoodBal %>% group_by(Area, Year, Item, Element) %>% summarise(Value = sum(Value))
unique(FoodBal$Item)

#--
FoodBal <- subset(FoodBal, Item %in% item_vec)
FoodBal$Group <- NA
u <- FoodBal$Item
FoodBal$Group[which(u %in% cereal_vec)] <- "Cereals"
FoodBal$Group[which(u %in% RnT_vec)] <- "RnT"
FoodBal$Group[which(u %in% oil_vec)] <- "Oils"
FoodBal$Group[which(u %in% sugar_vec)] <- "Sugars"
FoodBal$Group[which(u %in% fruits_vec)] <- "Fruit"
FoodBal$Group[which(u %in% pulses_vec)] <- "Pulses"
FoodBal$Group[which(u %in% teaCoffeeCacao)] <- "Tea, coffee, cacao"
FoodBal$Group[which(u %in% textileIndustrial)] <- "Industrial (textile, rubber)"




foodbal_items_keep <- c("Cereals - Excluding Beer",
                        "Starchy Roots",
                        "Sugar (Raw Equivalent)",
                        "Pulses",
                        "Oilcrops",
                        "Vegetable Oils",
                        "Vegetables",
                        "Fruits - Excluding Wine",
                        "Coffee and Products",
                        "Cocoa Beans and products",
                        "Tea (including mate)")

FoodBal <- subset(FoodBal, Item %in% foodbal_items_vec)
u <- FoodBal$Item
#FoodBal$Item[which(u %in% c("Miscellaneous", "Spices", "Stimulants", "Treenuts", "Oilcrops","Alcoholic Beverages"))] <- "Other"
#FoodBal$Item[which(u %in% c("Miscellaneous", "Spices", "Stimulants", "Treenuts", "Alcoholic Beverages"))] <- "Other"
FoodBal$Item[which(u %in% c("Vegetables", "Vegetable Oils"))] <- "Vegetables"
FoodBal$Item[which(u == "Fruits - Excluding Wine")] <- "Fruits"
#FoodBal$Item[grep("Sugar", u)] <- "Sugar"
FoodBal$Item[grep("Cereals", u)] <- "Cereals"
u <- FoodBal$Element
#-------------
element_vec <- c("Stock Variation", "Import Quantity")
FoodBal_SUR <- subset(FoodBal, Element %in% c("Food supply (kcal/capita/day)", "Food supply quantity (kg/capita/yr)"))
FoodBal$Value[is.na(FoodBal$Value)] <- 0
FoodBal <- FoodBal %>% group_by(Area, Element, Year, Item) %>% summarise(Value = sum(Value))
FoodBal_wide <- FoodBal %>% spread(Element, Value)
#FoodBal_wide$SVar <- FoodBal_wide$Production + FoodBal_wide$`Import Quantity` - FoodBal_wide$`Export Quantity` - FoodBal_wide$Use

unique(FoodBal$Element)
df <- subset(FoodBal, Element %in% c("Stock Variation", "Food supply (kcal/capita/day)"))
df <- subset(df, Area %in% c("South America",
                             "Eastern Asia",
                             "Central Asia",
                             "Southern Asia",
                             "South-Eastern Asia"))
df_wide <- df %>% spread(Element, Value)
df_wide$SVar <- df_wide$Production + df_wide$`Import Quantity` - df_wide$`Export Quantity` - df_wide$Use
df_wide <- df_wide[, c("Area", "Year", "Stock Variation", "SVar")]
df_long <- df_wide %>% gather(Element, Value, `Stock Variation`:SVar)

df_long$Year <- as.integer(df_long$Year)
ggplot(df_long, aes(x = Year, y = Value, group = Element, color = Element)) + geom_line() + facet_wrap(~Area, ncol = 2)



df_SVar <- FoodBal_wide[, c("Item", "Year", "SVar")]
df_SVar <- df_SVar %>% spread(Item, SVar)
n_yrs <- length(unique(FoodBal_wide$Year))
outlist <- list(); t <- 0
for(j in 2:ncol(df_SVar))
{
  y <- c()
  y[1] <- 0
  for(i in 2:n_yrs){y[i] <- y[i - 1] + df_SVar[(i - 1), j]}
  t <- t + 1
  outlist[[t]] <- as.numeric(y)
  
}
df_out <- as.data.frame(do.call(cbind, outlist))
factr <- min(df_out) * sign(minval)
outlist <- list(); t <- 0
for(j in 2:ncol(df_SVar))
{
  y <- c()
  y[1] <- 1.01 * factr
  for(i in 2:n_yrs){y[i] <- y[i - 1] + df_SVar[(i - 1), j]}
  
  t <- t + 1
  outlist[[t]] <- as.numeric(y)
  
}
df_EndStocks <- as.data.frame(do.call(cbind, outlist))
colnames(df_EndStocks) <- paste(colnames(df_SVar)[2:ncol(df_SVar)], "Ending Stocks")
df_EndStocks$Year <- df_SVar$Year
df_Use <- FoodBal_wide[, c("Item", "Year", "Use")]
df_Use <- df_Use %>% spread("Item", "Use")
colnames(df_Use)[2:ncol(df_Use)] <- paste(colnames(df_Use)[2:ncol(df_Use)], "Use")
df_SUR <- merge(df_Use, df_EndStocks, by = "Year")
df_SUR <- df_SUR %>% gather(Item, Value, `Cereals Use`:`Sugar (Raw Equivalent) Ending Stocks`)
df_SUR$Element <- NA
df_SUR$Element[grep("Use", df_SUR$Item)] <- "Use"
df_SUR$Element[grep("Ending", df_SUR$Item)] <- "Ending Stocks"  
df_SUR$Item <- gsub(" Use", "", df_SUR$Item)
df_SUR$Item <- gsub(" Ending Stocks", "", df_SUR$Item)
df_SUR <- df_SUR %>% spread(Element, Value)
df_SUR$SUR <- df_SUR$`Ending Stocks` / df_SUR$Use
df_SUR$Year <- as.integer(df_SUR$Year)
gg <- ggplot(df_SUR, aes(x = Year, y = SUR, group = Item, color = Item)) + geom_line()
gg

#-------------
# FoodBal <- subset(FoodBal, Element %in% c("Food supply (kcal/capita/day)", "Food supply quantity (kg/capita/yr)"))
# ind <- which(FoodBal$Element == "Food supply quantity (kg/capita/yr)")
# FoodBal$Value[ind] <- FoodBal$Value[ind] / 365
# FoodBal$Element[ind] <- "Food supply quantity (kg/capita/day)"
# FoodBal <- subset(FoodBal, Item.Code != 2914) #Vegetables repeated
# FoodBal <- FoodBal %>% group_by(Area, Element, Year, Item) %>% summarise(Value = sum(Value))
unique(FoodBal$Element)
#-------------

df_monthPrice_raw <- read.csv("Prices_Monthly_E_All_Data.csv", stringsAsFactors = F)
u <- colnames(df_monthPrice_raw)
df_monthPrice_raw <- df_monthPrice_raw[, -grep("F", u)]
df_monthPrice_raw <- df_monthPrice_raw[, c("Area", "Item", "Element", "Months", "Y2010", 
                                           "Y2011", "Y2012", "Y2013", "Y2014", "Y2015")]
#unique(df_monthPrice_raw$Item)
u <- colnames(df_monthPrice_raw)
colnames(df_monthPrice_raw) <- gsub("Y2", "2", u)
df_monthPrice <- subset(df_monthPrice_raw, Area %in% "Ethiopia")
df_monthPrice <- df_monthPrice[, c("Area", "Item", "Element", "Months", "2010")]
df_monthPrice <- subset(df_monthPrice, Item == "Maize")


# FoodBal_wide <- spread(FoodBal, Element, Value)
# FoodBal_wide[is.na(FoodBal_wide)] <- 0

kcal_carb <- FoodBal_wide$`Food supply (kcal/capita/day)` - 9 * FoodBal_wide$`Fat supply quantity (g/capita/day)` - 4 * FoodBal_wide$`Protein supply quantity (g/capita/day)`
FoodBal_wide$`Carbs (kcal/capita/day)` <- kcal_carb
#FoodBal_wide$`Food supply (kcal/capita/day)` <- NULL
FoodBal_wide$`Fat supply quantity (g/capita/day)` <- NULL
FoodBal_wide$`Protein supply quantity (g/capita/day)` <- NULL
rm(kcal_carb)
FoodBal_tot <- subset(FoodBal_wide, Item == "Grand Total")
FoodBal_tot$Item <- NULL
u <- colnames(FoodBal_tot)
colnames(FoodBal_tot)[grep("kcal", u)] <- paste("Total", colnames(FoodBal_tot)[grep("kcal", u)])
rm(u)
FoodBal_wide <- subset(FoodBal_wide, Item != "Grand Total")
FoodBal_wide <- merge(FoodBal_wide, FoodBal_tot, by = c("Area", "Year"))
carb_x <- FoodBal_wide$`Carbs (kcal/capita/day)`
carb_tot <- FoodBal_wide$`Total Carbs (kcal/capita/day)`
kcal_tot <- FoodBal_wide$`Total Food supply (kcal/capita/day)`
FoodBal_wide$`Carb share of total kcal (area level)` <- carb_tot / kcal_tot
FoodBal_wide$`Carb share of total carbs (area item level)` <- carb_x / carb_tot
rm(carb_x, carb_tot, kcal_tot)










#===========================
#SUR analysis
#FAO documentation:
#http://www.fao.org/economic/the-statistics-division-ess/methodology/methodology-systems/supply-utilization-accounts-and-food-balance-sheets-background-information-for-your-better-understanding/en/
#from stocks + production + imports = exports + feed + seed + waste + processing for food + food + other utilization
#production + imports = exports + feed + seed + waste + processing for food + food + other utilization + to stocks
#Where "from stocks" means "carry over"
#and "to stocks" means "ending stocks"
#Note also that: Domestic supply quantity = feed + seed + waste + processing for food + food + other utilization
#Thus:
#from stocks + production + imports = exports + Domestic supply quantity
#production + imports = exports + Domestic supply quantity + to stocks
#--> Carry over = exports + Domestic supply quantity - production - imports
#--> Ending stocks = production + imports - exports - Domestic supply quantity

#unique(FoodBal_raw$Element)

subregion_vec <- "World"
FoodBal <- subset(FoodBal_raw, Area %in% subregion_vec)
FoodBal <- subset(FoodBal, Element %in% c("Production", "Export Quantity", "Import Quantity", "Domestic supply quantity", "Food", "Stock Variation"))

u <- FoodBal$Element
FoodBal$Element[which(u=="Domestic supply quantity")] <- "Use"
#FoodBal_sur$Use = FoodBal_sur$Feed + FoodBal_sur$Food + FoodBal_sur$Seed + FoodBal_sur$Waste + FoodBal_sur$Processing + FoodBal_sur$`Other uses`
unique(FoodBal$Item)
FoodBal <- subset(FoodBal, Item %in% c("Grand Total",
                                       "Animal Products",
                                       "Cereals - Excluding Beer",
                                       "Starchy Roots",
                                       #                                            "Sugar Crops",
                                       #                                            "Sugar & Sweeteners",
                                       "Sugar (Raw Equivalent)",
                                       "Pulses",
                                       "Treenuts",
                                       "Oilcrops",
                                       "Vegetable Oils",
                                       "Vegetables",
                                       "Fruits - Excluding Wine",
                                       "Stimulants",
                                       "Spices",
                                       "Alcoholic Beverages",
                                       "Miscellaneous"))
u <- FoodBal$Item
#FoodBal$Item[which(u %in% c("Miscellaneous", "Spices", "Stimulants", "Treenuts", "Oilcrops","Alcoholic Beverages"))] <- "Other"
FoodBal$Item[which(u %in% c("Miscellaneous", "Spices", "Stimulants", "Treenuts", "Alcoholic Beverages"))] <- "Other"
FoodBal$Item[which(u %in% c("Vegetables", "Vegetable Oils", "Fruits - Excluding Wine"))] <- "Fruits & Vegetables"
#FoodBal$Item[grep("Sugar", u)] <- "Sugar"
FoodBal$Item[grep("Cereals", u)] <- "Cereals"
FoodBal$Value[is.na(FoodBal$Value)] <- 0
FoodBal <- FoodBal %>% group_by(Element, Year, Item) %>% summarise(Value = sum(Value))
FoodBal_wide <- spread(FoodBal, Element, Value)


df_SVar <- FoodBal_wide[, c("Item", "Year", "SVar")]
df_SVar <- df_SVar %>% spread(Item, SVar)
n_yrs <- length(unique(FoodBal_wide$Year))
outlist <- list(); t <- 0
for(j in 2:ncol(df_SVar))
{
  y <- c()
  y[1] <- 0
  for(i in 2:n_yrs){y[i] <- y[i - 1] + df_SVar[(i - 1), j]}
  t <- t + 1
  outlist[[t]] <- as.numeric(y)
  
}
df_out <- as.data.frame(do.call(cbind, outlist))
minval <- min(df_out)
factr <- minval * sign(minval)
outlist <- list(); t <- 0
for(j in 2:ncol(df_SVar))
{
  y <- c()
  y[1] <- 1.01 * factr
  for(i in 2:n_yrs){y[i] <- y[i - 1] + df_SVar[(i - 1), j]}
  
  t <- t + 1
  outlist[[t]] <- as.numeric(y)
  
}
df_EndStocks <- as.data.frame(do.call(cbind, outlist))
colnames(df_EndStocks) <- c(colnames(df_SVar)[2:ncol(df_SVar)])
# colnames(df_EndStocks) <- paste(colnames(df_SVar)[2:ncol(df_SVar)], "Ending Stocks")
df_EndStocks$Year <- df_SVar$Year
df_EndStocks <- df_EndStocks %>% gather(Item, `Ending Stocks`, `Cereals`:`Sugar (Raw Equivalent)`)
FoodBal_wide <- merge(FoodBal_wide, df_EndStocks, by = c("Year", "Item"))
FoodBal_wide$Supply <- FoodBal_wide$Production + FoodBal_wide$`Import Quantity` + FoodBal_wide$`Ending Stocks`
#--------------
#Compare SUR with price
ExportData_raw <- read.csv("Trade_Crops_Livestock_E_All_Data.csv")
ExportData_raw <- subset(ExportData_raw, Item.Code != 2928)
ExportData_raw$Area.Code <- NULL
ExportData_raw$Element.Code <-NULL
ExportData_raw$Item <- as.character(ExportData_raw$Item)
ExportData_raw$Element <- as.character(ExportData_raw$Element)
ExportData_raw$Area <- as.character(ExportData_raw$Area)
u <- colnames(ExportData_raw)
ExportData_raw <- ExportData_raw[, -grep("F", u)]
colnames(ExportData_raw)[6:ncol(ExportData_raw)] <- as.character(c(1961:2013))
ExportData_raw <- gather(ExportData_raw,Year,Value,`1961`:`2013`)
rm(u)
#----------------------------------
ExportData <- subset(ExportData_raw, Element %in% c("Export Quantity", "Export Value"))
ExportData <-  subset(ExportData, Area %in% c("World"))
unique(ExportData_raw$Item)[grep("Sugar", unique(ExportData_raw$Item))]
ExportData <- subset(ExportData, Item %in% c("Roots and tubers, nes", "Cereals", "Pulses", "Oilseeds, nes", "Sugar,Total (Raw Equiv.)"))
ExportData$Item.Code <- NULL
ExportData$Unit <- NULL
#ExportData$Value[which(is.na(ExportData$Value))] <- 0
ExportData_wide <- spread(ExportData, Element, Value)
ExportData_wide <- ExportData_wide[order(ExportData_wide$Area, ExportData_wide$Year),]
ExportData_wide$Price <- 1000 * as.numeric(ExportData_wide$`Export Value`) / as.numeric(ExportData_wide$`Export Quantity`)
ExportData_wide$Year <- as.integer(ExportData_wide$Year)
u <- ExportData_wide$Item
ExportData_wide$Item[grep("Roots", u)] <- "Starchy Roots"
ExportData_wide$Item[grep("Oilseeds", u)] <- "Oilcrops"
ExportData_wide$Item[grep("Sugar", u)] <- "Sugar (Raw Equivalent)"
rm(u)
#------------------
df_Price <- ExportData_wide[, c("Item", "Year", "Price")]
df_Price_wide <- df_Price %>% spread(Item, Price)
# df_Value <- ExportData_wide[, c("Item", "Year", "Export Value")]
# df_Value_wide <- df_Value %>% spread(Item, `Export Value`)
FoodBal_wide <- subset(FoodBal_wide, Item %in% c("Starchy Roots", "Cereals", "Pulses", "Sugar (Raw Equivalent)"))
df <- merge(FoodBal_wide, df_Price, by = c("Year", "Item"))
gg <- ggplot(df, aes(x = Supply, y = Price)) + geom_point() + facet_wrap(~Item, ncol = 2, scales = "free")
gg




FoodBal_wide$SVar <- FoodBal_wide$Production + FoodBal_wide$`Import Quantity` - FoodBal_wide$`Export Quantity` - FoodBal_wide$Use
#FoodBal_wide$test <- FoodBal_wide$`Stock Variation` / FoodBal_wide$SVar









df_Use <- FoodBal_wide[, c("Item", "Year", "Use")]
df_Use <- df_Use %>% spread("Item", "Use")
colnames(df_Use)[2:ncol(df_Use)] <- paste(colnames(df_Use)[2:ncol(df_Use)], "Use")
df_SUR <- merge(df_Use, df_EndStocks, by = "Year")
df_SUR <- df_SUR %>% gather(Item, Value, `Cereals Use`:`Sugar (Raw Equivalent) Ending Stocks`)
df_SUR$Element <- NA
df_SUR$Element[grep("Use", df_SUR$Item)] <- "Use"
df_SUR$Element[grep("Ending", df_SUR$Item)] <- "Ending Stocks"
df_SUR$Item <- gsub(" Use", "", df_SUR$Item)
df_SUR$Item <- gsub(" Ending Stocks", "", df_SUR$Item)
df_SUR <- df_SUR %>% spread(Element, Value)
df_SUR$SUR <- df_SUR$`Ending Stocks` / df_SUR$Use
df_SUR$Year <- as.integer(df_SUR$Year)
gg <- ggplot(df_SUR, aes(x = Year, y = SUR, group = Item, color = Item)) + geom_line()
gg
#--------------
#Compare SUR with price
ExportData_raw <- read.csv("Trade_Crops_Livestock_E_All_Data.csv")
ExportData_raw <- subset(ExportData_raw, Item.Code != 2928)
ExportData_raw$Area.Code <- NULL
ExportData_raw$Element.Code <-NULL
ExportData_raw$Item <- as.character(ExportData_raw$Item)
ExportData_raw$Element <- as.character(ExportData_raw$Element)
ExportData_raw$Area <- as.character(ExportData_raw$Area)
u <- colnames(ExportData_raw)
ExportData_raw <- ExportData_raw[, -grep("F", u)]
colnames(ExportData_raw)[6:ncol(ExportData_raw)] <- as.character(c(1961:2013))
ExportData_raw <- gather(ExportData_raw,Year,Value,`1961`:`2013`)
rm(u)
#----------------------------------
ExportData <- subset(ExportData_raw, Element %in% c("Export Quantity", "Export Value"))
ExportData <-  subset(ExportData, Area %in% c("World"))
unique(ExportData_raw$Item)[grep("Sugar", unique(ExportData_raw$Item))]
ExportData <- subset(ExportData, Item %in% c("Roots and tubers, nes", "Cereals", "Pulses", "Oilseeds, nes", "Sugar,Total (Raw Equiv.)"))
ExportData$Item.Code <- NULL
ExportData$Unit <- NULL
#ExportData$Value[which(is.na(ExportData$Value))] <- 0
ExportData_wide <- spread(ExportData, Element, Value)
ExportData_wide <- ExportData_wide[order(ExportData_wide$Area, ExportData_wide$Year),]
ExportData_wide$Price <- 1000 * as.numeric(ExportData_wide$`Export Value`) / as.numeric(ExportData_wide$`Export Quantity`)
ExportData_wide$Year <- as.integer(ExportData_wide$Year)
u <- ExportData_wide$Item
ExportData_wide$Item[grep("Roots", u)] <- "Starchy Roots"
ExportData_wide$Item[grep("Oilseeds", u)] <- "Oilcrops"
ExportData_wide$Item[grep("Sugar", u)] <- "Sugar (Raw Equivalent)"
rm(u)
#------------------
df_Price <- ExportData_wide[, c("Item", "Year", "Price")]
df_Price_wide <- df_Price %>% spread(Item, Price)
df_Value <- ExportData_wide[, c("Item", "Year", "Export Value")]
df_Value_wide <- df_Value %>% spread(Item, `Export Value`)
df_SUR2 <- df_SUR[, c("Item", "Year", "SUR")]
df_SUR2 <- subset(df_SUR2, Item %in% c("Cereals", "Starchy Roots", "Pulses", "Sugar (Raw Equivalent)")) 
df_SUR_wide <- df_SUR2 %>% spread(Item, SUR)
outlist_price <- list()
outlist_value <- list()
outlist_sur <- list()
for(i in 2:ncol(df_Price_wide))
{
  outlist_price[[i-1]] <- c(NA, diff(df_Price_wide[, i]))
  outlist_value[[i-1]] <- c(NA, diff(df_Value_wide[, i]))
  outlist_sur[[i-1]] <- c(NA, diff(df_SUR_wide[, i]))
}
df_PriceDiff <- as.data.frame(do.call(cbind, outlist_price))
df_ValueDiff <- as.data.frame(do.call(cbind, outlist_value))
df_SURDiff <- as.data.frame(do.call(cbind, outlist_sur))
colnames(df_PriceDiff) <- paste(colnames(df_Price_wide)[2:ncol(df_Price_wide)], "Price diff")
colnames(df_ValueDiff) <- paste(colnames(df_Value_wide)[2:ncol(df_Value_wide)], "Value diff")
colnames(df_SURDiff) <- paste(colnames(df_SUR_wide)[2:ncol(df_SUR_wide)], "SUR diff")
df_PriceDiff$Year <- df_Price_wide$Year
df_ValueDiff$Year <- df_Value_wide$Year
df_SURDiff$Year <- df_SUR_wide$Year

df_plot <- df_SURDiff
gathercols <- colnames(df_plot)[1:(ncol(df_plot) - 1)]
df_plot <- df_plot %>% gather_("Item", "Value", gathercols)
ggplot(df_plot, aes(x = Year, y = Value, group = Item, color = Item)) + geom_line()

library(corrplot)
df_Corr <- df_SURDiff[2:nrow(df_Corr), 1:(ncol(df_Corr) - 1)]
corMatMy <- cor(df_Corr)
corrplot(corMatMy, order = "hclust")


zdf_Price <- as.data.frame(apply(df_Price_wide[, 2:ncol(df_Price_wide)], 2, scale))
zdf_Price$Year <- df_Price_wide$Year
zdf_Price <- zdf_Price %>% gather(Item, zPrice, Cereals:`Sugar (Raw Equivalent)`)
df_SVar <- df_SVar %>% gather(Item, `Stock Variation`, Cereals:`Sugar (Raw Equivalent)`)
df_SUR <- df_SUR[, c("Item", "Year", "SUR")]
df_SUR_Price <- join_all(list(df_SUR, df_SVar, zdf_Price))
df_SUR_Price <- subset(df_SUR_Price, !(Item %in% c("Oilcrops", "Other", "Fruits & Vegetables")))
df_plot <- df_SUR_Price
df_plot <- df_plot %>% gather(Var, Value, SUR:zPrice)
df_plot <- subset(df_plot, Var != "Stock Variation")
gg <- ggplot(df_plot, aes(x = Year, y = Value, group = Var, color = Var))
gg <- gg + geom_line() + facet_wrap(~Item, ncol = 2)
gg

zdf <- as.data.frame(scale(df_SUR_price[, ]))



#ExportData_wide <- ExportData_wide %>% gather(Var, Value, `Export Quantity`:Price)



























#=====================================
#Examine use profiles
#-----------------------

c("Feed", "Food", "Seed", "Waste", "Processing", "Other uses", "Domestic supply quantity")

#FoodBal_wide$Seed[is.na(FoodBal_wide$Seed)] <- 0

u <- colnames(FoodBal_wide)
FoodBal_wide$`Feed share` <- FoodBal_wide$Feed / FoodBal_wide$Use
FoodBal_wide$`Food share` <- FoodBal_wide$Food / FoodBal_wide$Use
FoodBal_wide$`Seed share` <- FoodBal_wide$Seed / FoodBal_wide$Use
FoodBal_wide$`Waste share` <- FoodBal_wide$Waste / FoodBal_wide$Use
FoodBal_wide$`Processing share` <- FoodBal_wide$Processing / FoodBal_wide$Use
FoodBal_wide$`Other share` <- FoodBal_wide$`Other uses` / FoodBal_wide$Use
FoodBal_wide$`Non-food share` <- 1 - FoodBal_wide$`Food share`

FoodBal_long <- gather(FoodBal_wide,Element,Value, Feed:`Other share`)
u <- unique(FoodBal_long$Element[grep("share",FoodBal_long$Element)])
FoodBal_long <- subset(FoodBal_long, Element %in% u)
FoodBal_long$Year <- as.numeric(FoodBal_long$Year)
FoodBal_long <- subset(FoodBal_long, Area %in% c("Africa", "Asia", "South America", "Northern America", "Europe", "World"))
FoodBal_long$Region <- NULL

df_plot <- FoodBal_long
gg <- ggplot(df_plot, aes(x=Year, y=Value, fill = Element))
gg <- gg + geom_area(position = "stack") + xlab('Year') + ylab('Share')
gg <- gg + facet_wrap(~ Area, ncol = 2, nrow = 3)
gg <- gg + ggtitle("Evolution of cereal use profile, world and by continent")
gg
df_plot <- subset(FoodBal_long, Item == "Starchy Roots")
gg <- ggplot(df_plot, aes(x=Year, y=Value, fill = Element))
gg <- gg + geom_area(position = "stack") + xlab('Year') + ylab('Share')
gg <- gg + facet_wrap(~ Area, ncol = 2, nrow = 3)
gg <- gg + ggtitle("Evolution of starchy root use profile, world and by continent")
gg
df_plot <- subset(FoodBal_long, Item == "Cassava and products")
gg <- ggplot(df_plot, aes(x=Year, y=Value, fill = Element))
gg <- gg + geom_area(position = "stack") + xlab('Year') + ylab('Share')
gg <- gg + facet_wrap(~ Area, ncol = 2, nrow = 3)
gg <- gg + ggtitle("Evolution of cassava (and products) use profile, world and by continent")
gg
#---------------

#unique(FoodBal_raw$Element)
FoodBal_sur <- subset(FoodBal_raw, Element %in% c("Domestic supply quantity", "Production", "Import Quantity", "Export Quantity", "Stock Variation","Feed", "Food", "Seed", "Waste", "Processing", "Other uses"))
FoodBal_sur <- subset(FoodBal_sur, Item %in% c("Cassava and products", "Cereals - Excluding Beer", 
                                               "Sorghum and products", "Potatoes and products",
                                               "Starchy Roots"))
#spread(FoodBal_kcal,Element,Value)
FoodBal_sur <- spread(FoodBal_sur,Element,Value)

for(i in 4:ncol(FoodBal_sur))
{
  u <- FoodBal_sur[,i]
  FoodBal_sur[is.na(u),i] <- 0
}

FoodBal_sur$Use = FoodBal_sur$Feed + FoodBal_sur$Food + FoodBal_sur$Seed + FoodBal_sur$Waste + FoodBal_sur$Processing + FoodBal_sur$`Other uses`
FoodBal_sur$`Ending stocks` <- FoodBal_sur$Production + FoodBal_sur$`Import Quantity` - FoodBal_sur$Use
#FoodBal_sur$`Opening stocks` <- - FoodBal_sur$Production - FoodBal_sur$`Import Quantity` + FoodBal_sur$`Export Quantity` + FoodBal_sur$`Domestic supply quantity`
#FoodBal_sur$check <- (FoodBal_sur$`Ending stocks` - FoodBal_sur$`Opening stocks`) / FoodBal_sur$`Stock Variation`
FoodBal_sur$SUR <- FoodBal_sur$`Ending stocks` / FoodBal_sur$Use
































df_raw <- read.csv("FAOSTAT_CPIfood.csv", stringsAsFactors = F)
df <- df_raw[, c("Area", "Item", "Year", "Months", "Value")]
country_vec <- c("Kenya", "Ethiopia", "Uganda")
df <- subset(df, Area %in% country_vec)
df <- df %>% group_by(Area, Year) %>% summarize(Value_mu = mean(Value), Value_sd = sd(Value))
df$Value_cv <- df$Value_sd / df$Value_mu

gg <- ggplot(df, aes(x = Year, y = Value_cv, group = Area, color = Area)) + geom_line()
gg

df$lValue_mu <- log(df$Value_mu)
df$lValue_sd <- log(df$Value_sd)

gg <- ggplot(df, aes(x = lValue_mu, y = lValue_sd, group = Area, color = Area)) + geom_point()
gg
